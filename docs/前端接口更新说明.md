# 问诊接口更新说明

## 一、更新概述

为了提升用户体验和满足更多场景的需求，我们对问诊相关接口进行了以下更新：

1. 优化了发送问诊消息接口，增加了更多参数控制，并实现了立即获取AI回复
2. 新增了医疗问答接口，支持用户在不创建会话的情况下进行医疗咨询

## 二、接口详细说明

### 1. 发送问诊消息接口（优化）

该接口已更新为发送消息后立即获取AI的回复，不再需要单独调用获取回复的接口。

**接口地址**：`/consult/sessions/{sessionId}/messages`

**请求方法**：POST

**请求头**：
- `Authorization`: JWT令牌

**请求参数**：
```json
{
  "content": "我想详细了解一下高血压患者的饮食注意事项",
  "content_type": "text",
  "language": "chinese",
  "max_tokens": 1024,
  "temperature": 0.7
}
```

**参数说明**：
- `content`: 消息内容（必填）
- `content_type`: 消息类型，默认为"text"
- `language`: 语言，支持"chinese"或"mongolian"（可选，默认chinese）
- `max_tokens`: 回答的最大长度（可选，默认1024）
- `temperature`: 控制回答的随机性，越高越有创意（可选，默认0.7）

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "user_message": {
      "id": 3,
      "session_id": 1,
      "sender_type": "user",
      "content": "我想详细了解一下高血压患者的饮食注意事项",
      "content_type": "text",
      "created_at": "2023-05-10 10:15:00"
    },
    "ai_message": {
      "id": 4,
      "session_id": 1,
      "sender_type": "ai",
      "content": "高血压患者在饮食方面应注意以下几点：\n\n1. 控制钠盐摄入：每天食盐摄入量应控制在5克以下...",
      "content_type": "text",
      "created_at": "2023-05-10 10:15:05"
    },
    "time_taken": 1.25
  }
}
```

### 2. 医疗问答接口（新增）

该接口允许用户在不创建问诊会话的情况下，直接进行单次医疗咨询。

**接口地址**：`/consult/medical-qa`

**请求方法**：POST

**请求头**：
- `Authorization`: JWT令牌

**请求参数**：
```json
{
  "query": "高血压患者日常应该注意什么？",
  "language": "chinese",
  "max_tokens": 1024,
  "temperature": 0.7
}
```

**参数说明**：
- `query`: 用户的医疗问题（必需）
- `language`: 语言，支持"chinese"或"mongolian"（可选，默认chinese）
- `max_tokens`: 回答的最大长度（可选，默认1024）
- `temperature`: 控制回答的随机性，越高越有创意（可选，默认0.7）

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "response": "高血压患者日常应注意以下几点：\n1. 定期监测血压，保持血压稳定\n2. 合理饮食，减少盐分和脂肪摄入...",
    "time_taken": 3.21
  }
}
```

## 三、前端修改建议

### 1. 问诊会话页面修改

原有的问诊会话页面需要进行以下修改：

1. 发送消息函数更新：
```javascript
// 原有代码
async function sendMessage(content) {
  try {
    // 发送用户消息
    const response = await api.post(`/consult/sessions/${sessionId}/messages`, {
      content,
      content_type: 'text'
    });
    
    // 显示用户消息
    displayMessage(response.data.data, 'user');
    
    // 显示"正在输入"状态
    showTypingIndicator();
    
    // 获取AI回复（原来需要单独调用）
    // 此部分代码不再需要
    
    // 隐藏"正在输入"状态
    hideTypingIndicator();
  } catch (error) {
    // 错误处理
  }
}

// 更新后的代码
async function sendMessage(content) {
  try {
    // 显示"正在输入"状态
    showTypingIndicator();
    
    // 发送用户消息并立即获取AI回复
    const response = await api.post(`/consult/sessions/${sessionId}/messages`, {
      content,
      content_type: 'text',
      language: 'chinese', // 可根据用户设置动态调整
      max_tokens: 1024,
      temperature: 0.7
    });
    
    // 隐藏"正在输入"状态
    hideTypingIndicator();
    
    // 显示用户消息
    displayMessage(response.data.data.user_message, 'user');
    
    // 显示AI回复
    displayMessage(response.data.data.ai_message, 'ai');
    
    // 可选：显示响应时间
    showResponseTime(response.data.data.time_taken);
  } catch (error) {
    // 错误处理
    hideTypingIndicator();
  }
}
```

2. 消息展示组件更新：
   - 根据更新后的响应格式调整消息展示逻辑
   - 添加对响应时间的展示（如需要）

### 2. 新增"快速咨询"功能

可以在应用中添加一个新的"快速咨询"功能，调用新增的医疗问答接口：

```javascript
// 快速咨询功能
async function quickConsult(query) {
  try {
    // 显示加载状态
    showLoading();
    
    // 调用医疗问答API
    const response = await api.post('/consult/medical-qa', {
      query,
      language: 'chinese', // 可根据用户设置动态调整
      max_tokens: 1024,
      temperature: 0.7
    });
    
    // 隐藏加载状态
    hideLoading();
    
    // 显示AI回复
    displayQuickConsultResponse(response.data.data.response);
    
    // 可选：显示响应时间
    showResponseTime(response.data.data.time_taken);
    
    // 可选：提供"创建会话"选项，允许用户将此次咨询转化为持续会话
    showCreateSessionOption(query, response.data.data.response);
  } catch (error) {
    // 错误处理
    hideLoading();
  }
}
```

### 3. UI/UX建议

1. 问诊会话页面：
   - 在消息输入框附近添加高级选项下拉菜单，允许用户调整语言、回复长度和随机性参数
   - 显示AI回复的响应时间，提高用户体验透明度

2. 快速咨询功能：
   - 在首页或健康资讯页面添加"快速咨询"入口
   - 设计简洁的问答界面，包含问题输入框和回答显示区域
   - 提供"创建会话"按钮，允许用户将快速咨询转化为完整会话

3. 语言切换：
   - 为蒙语用户提供明显的语言切换选项
   - 在界面上清晰标识当前使用的语言

## 四、接口调用示例

### 发送问诊消息

```javascript
const axios = require('axios');

async function sendConsultMessage(sessionId, content) {
  try {
    const response = await axios.post(`/api/consult/sessions/${sessionId}/messages`, {
      content: content,
      content_type: 'text',
      language: 'chinese',
      max_tokens: 1024,
      temperature: 0.7
    }, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    console.log('用户消息:', response.data.data.user_message);
    console.log('AI回复:', response.data.data.ai_message);
    console.log('响应时间:', response.data.data.time_taken, '秒');
    
    return response.data;
  } catch (error) {
    console.error('发送消息失败:', error);
    throw error;
  }
}
```

### 医疗快速问答

```javascript
const axios = require('axios');

async function quickMedicalQA(query) {
  try {
    const response = await axios.post('/api/consult/medical-qa', {
      query: query,
      language: 'chinese',
      max_tokens: 1024,
      temperature: 0.7
    }, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    console.log('AI回复:', response.data.data.response);
    console.log('响应时间:', response.data.data.time_taken, '秒');
    
    return response.data;
  } catch (error) {
    console.error('医疗问答失败:', error);
    throw error;
  }
}
```

## 五、注意事项

1. 接口参数调整：
   - `max_tokens`和`temperature`参数可以根据实际需求进行调整
   - 通常情况下，默认值已经能满足大多数场景需求

2. 错误处理：
   - 确保前端添加适当的错误处理机制
   - 对于网络超时等情况，应提供友好的用户提示

3. 性能考虑：
   - AI响应可能需要几秒钟时间，确保UI有适当的加载状态提示
   - 考虑添加请求超时处理，防止长时间等待 